# Backlog задач для команды (5 Go-разработчиков)

## Цель проекта

Разработать Telegram-бота, который принимает файлы экспорта чатов, извлекает участников и формирует результат в виде
списка или Excel-файла. Бот работает без сохранения пользовательских данных и поднимается через Docker.

---

## Общая архитектура системы

Основные компоненты:

- Telegram Bot API интеграция
- Модуль парсинга экспортов (JSON/HTML)
- Модуль извлечения участников / упоминаний / каналов
- Модуль генерации результата (Excel или текст)
- Политика приватности и управление временными данными
- Docker/Docker Compose + документация

---

## Задачи по разработчикам

### Dev1 — Архитектура и Telegram-бот

#### **Задача 1.1 — Архитектурный каркас проекта**

- Создать структуру проекта (`cmd/bot`, `internal/...`)
- Определить интерфейсы: `Parser`, `Extractor`, `Exporter`
- Написать `ARCHITECTURE.md`

**DoD:**

- `go mod init`, базовая структура каталогов
- Интерфейсы описаны и согласованы

#### **Задача 1.2 — Интеграция с Telegram Bot API**

- `/start`, `/help`
- Приём и учёт файлов (до 10)
- Хранение состояния сессии

**DoD:** бот принимает файлы и выводит понятные ошибки при превышении лимита

#### **Задача 1.3 — UX сценарий и тексты**

- Сценарий: `/start → загрузка файлов → обработка → результат`
- Сообщения: ошибки, лимиты, статус процесса, приватность

**DoD:** весь текст лежит в `messages.go`

---

### Dev2 — Парсинг экспортов

#### **Задача 2.1 — Поддержка форматов JSON/HTML**

- Определить формат по расширению
- Реализовать:
    - `ParseFile(io.Reader, string) ([]ChatEvent, error)`
- Тесты на примерах

#### **Задача 2.2 — Работа с кодировкой**

- Полная UTF-8-совместимость
- Без крашей на некорректных данных

**DoD:** тесты с кириллицей/emoji/разными кодировками

#### **Задача 2.3 — Объединение событий из нескольких файлов**

- Удаление дублей
- `MergeEvents(multi [][]ChatEvent) []ChatEvent`

**DoD:** тест на объединение пересекающихся экспортов

---

### Dev3 — Извлечение участников и бизнес-логика

#### **Задача 3.1 — Модель сущностей**

- Сущности `Participant`, `Mention`, `Channel`

#### **Задача 3.2 — Логика извлечения**

- Сбор всех авторов и всех упоминаний
- Фильтр удалённых аккаунтов
- Удаление дублей

#### **Задача 3.3 — Выбор формата результата**

- `< 50` участников → список в чат
- `≥ 51` участников → Excel
- Разделение на вкладки

**DoD:** тесты на 49 и 51 участников

---

### Dev4 — Excel и форматирование вывода

#### **Задача 4.1 — Генерация Excel**

Колонки:
| Поле | Описание |
|-------|-----------|
| Дата экспорта | время генерации файла |
| Username | @username |
| Имя и фамилия | из профиля |
| Описание | bio/about |
| Дата регистрации | при наличии |
| Наличие канала | да/нет |

**DoD:** `export_example.xlsx` в папке `examples/`

#### **Задача 4.2 — Форматирование списка для Telegram**

- Формирование списка `@username` построчно
- Разбиение на несколько сообщений при необходимости

---

### Dev5 — Приватность, Docker, документация

#### **Задача 5.1 — Управление временными файлами**

- Интерфейс `TempStorage`
- Удаление файлов сразу после обработки

**DoD:** тест: после успешной обработки файл удалён

#### **Задача 5.2 — Logging и конфигурация**

- Логи без PII
- ENV-конфигурация
- Документ `TECH_LIMITS.md` (размер файла, 10 файлов, поддерживаемые форматы)

#### **Задача 5.3 — Docker и README**

- `Dockerfile` + `docker-compose.yml`
- `README` с инструкцией запуска и user-guide
- Скриншоты примерного выводa

---

## Общие эпики

| Epic                                | Ответственные      |
|-------------------------------------|--------------------|
| Выбор библиотек и настройка проекта | вся команда        |
| Сквозной интеграционный тест        | Dev1 + Dev2 + Dev3 |
| Улучшение UX                        | вся команда        |

---

## Итоговые артефакты

- Рабочий Telegram-бот
- GitHub-репозиторий
- Docker-сборка
- Пример Excel + скриншоты
- `README.md`, `ARCHITECTURE.md`, `TECH_LIMITS.md`

---
Окей — сделаю **глубокую детализацию задач** с *описанием цели, шага реализации, входов/выходов, DoD, возможных рисков*.
Формат останется Markdown, чтобы можно было положить в репозиторий или в Jira (как basis). Если нужно — позже преобразую
в формат Jira Story + Subtasks.

---

# `BACKLOG-DETAILED.md`

# Детализированный backlog задач для команды (5 Go-разработчиков)

## Общая цель

Создать Telegram-бота, который:

- принимает экспорт истории чата (1–10 файлов);
- извлекает всех уникальных участников и упомянутых пользователей;
- формирует результат в виде списка или Excel-файла;
- работает без сохранения пользовательских данных на сервере.

---

## Dev1 — Архитектура и Telegram-бот

### **Задача 1.1 — Архитектурный каркас проекта**

**Цель:** создать основу проекта, разделив логику на независимые модули.

**Описание реализации:**

- Инициализировать проект: `go mod init`.
- Создать структуру каталогов:
- Определить интерфейсы:

```go
type Parser interface {
Parse(file io.Reader, filename string) ([]ChatEvent, error)
}

type Extractor interface {
Extract(events []ChatEvent) (ParticipantsResult, error)
}

type Exporter interface {
Export(result ParticipantsResult) ([]byte, error)
}
````

* Описать архитектуру в `ARCHITECTURE.md`.

**Входы:** требования продукта.
**Выходы:** документация + код каркаса.
**DoD:**

* Собирается `go build` без ошибок.
* Интерфейсы согласованы всей командой.
* Компоненты не зависят друг от друга напрямую.

---

### **Задача 1.2 — Реализация Telegram Bot API**

**Цель:** обеспечить базовый интерфейс общения с пользователем.

**Описание реализации:**

* Поднять бота: подключить `tgbotapi` (или альтернативу).
* Реализовать команды `/start`, `/help`, `/process`.
* Принимать файлы документов (`Message.Document`).
* Валидировать количество файлов: не больше 10.
* Хранить контекст сессии пользователя in-memory (map: userID → session).
* Передавать файлы дальше сервисам обработки.

**Состояние сессии:**

```go
type Session struct {
Files []TempFileReference
Status SessionStatus
}
```

**DoD:**

* Бот отвечает на `/start`.
* При загрузке 11-го файла — ошибка с сообщением пользователю.
* Сессия пользователя сбрасывается после обработки.

---

### **Задача 1.3 — UX Конвейер**

**Цель:** реализовать последовательные состояния работы бота.

**Описание:**

* Сценарий:

    1. `/start` — описание целей и инструкции.
    2. Пользователь отправляет файлы → бот считает количество.
    3. `/process` → запуск анализа.
    4. Сообщение «Обработка началась…»
    5. Сообщение «Готово» + файл/список
* Сообщения вынести в `messages.go`.

**DoD:**

* У бота есть позитивный сценарий E2E на макетных данных.
* Пользователь не может вызвать `/process`, если нет файлов.

---

## Dev2 — Парсинг экспортов файлов

### **Задача 2.1 — Поддержка JSON/HTML**

**Цель:** научить приложение читать файлы Telegram Export.

**Описание реализации:**

* Определить тип файла по расширению (`.json`, `.html`).
* Реализовать парсер JSON:

    * Распарсить структуру экспортов Telegram (`messages`, `from_id`, `text_entities`, `type`, `date_unixtime`,
      `actor`).
    * Собрать `ChatEvent`:

      ```go
      type ChatEvent struct {
          FromUserID string
          Username   string
          Text       string
          Mentions   []string
          Date       time.Time
          Type       string // message/service/channel/etc.
      }
      ```
* Реализовать упрощённый парсер HTML (минимально необходимые поля).

**DoD:**

* 3 тестовых файла корректно парсятся.
* Ошибка парсинга возвращается как `friendly user error`.

---

### **Задача 2.2 — Нормализация кодировок и ошибок**

**Цель:** избежать проблем с различными форматами и локалями.

**Описание:**

* Принудительное преобразование в UTF-8.
* Защита от emoji, диакритики, RTL-текста.
* Тесты с нестандартными символами.

**DoD:**

* Парсер не падает на смешанной кодировке.
* Все тесты проходят.

---

### **Задача 2.3 — Объединение событий из нескольких файлов**

**Цель:** обеспечить обработку нескольких экспортов одного чата.

**Описание реализации:**

* `MergeEvents` объединяет и сортирует по дате.
* Дубль определяется по комбинации:

    * from_id + text + date
* Сервис возвращает единый массив событий.

**DoD:**

* Два пересекающихся файла дают строго уникальные события.

---

## Dev3 — Извлечение участников

### **Задача 3.1 — Модель участия**

**Цель:** определить сущности участников, упоминаний и каналов.

**Описание:**

```go
type Participant struct {
ID           string
Username     string
FirstName    string
LastName     string
Bio          string
RegisteredAt *time.Time
HasChannel   bool
IsDeleted    bool
}
```

**DoD:** структура согласована с Dev4.

---

### **Задача 3.2 — Алгоритм извлечения участников**

**Цель:** собрать все уникальные данные.

**Описание:**

* Пробежать события:

    * собрать `FromUser`
    * распарсить `@mentions` внутри сообщений → `mentions[]`
* Исключить:

    * `IsDeleted == true`
    * пустые username
* Построить итоговую структуру:

```go
type ParticipantsResult struct {
Participants []Participant
Mentions     []Participant
Channels     []string
}
```

**DoD:** тест с разными сценариями (упоминания = авторы, пустые BIO и т.д.)

---

### **Задача 3.3 — Выбор формата ответа**

**Цель:** решить, в каком виде отдавать результат.

**Описание:**

* Правила:

    * `len(Participants) < 50` → список `@username`
    * `>=51` → Excel
* Сигнализировать Dev4 правильным `OutputFormat`.

**DoD:** юнит-тест: 49→list, 51→excel.

---

## Dev4 — Экспорт Excel и вывод сообщений

### **Задача 4.1 — Генерация Excel**

**Цель:** создать Excel с правильной структурой.

**Описание:**

* Использовать `excelize`.
* Создать листы:

    * `Participants`
    * `Mentions`
    * `Channels`
* Заголовки и формат колонок.
* Добавить timestamp экспорта.

**DoD:**

* Excel открывается в Apple Numbers/Google Sheets/Excel.
* Выложен пример `examples/export_example.xlsx`.

---

### **Задача 4.2 — Форматирование списка для Telegram**

**Цель:** аккуратный UI в чат-режиме.

**Описание:**

* Формат: список `@username`, 1 строка = 1 пользователь.
* Если > 3500 символов → отправить несколько сообщений.

**DoD:**

* Сообщение не рвётся Telegram-лимитом.

---

## Dev5 — Приватность, Docker, документация

### **Задача 5.1 — Управление временными файлами**

**Цель:** гарантировать удаление данных.

**Описание:**

* Интерфейс:

  ```go
  type TempStorage interface {
     Save(name string, r io.Reader) (string, error)
     Read(path string) (io.ReadCloser, error)
     Delete(path string) error
  }
  ```
* Удаление файлов после завершения `/process`.

**DoD:**

* Интеграционный тест: после обработки файлов в системе нет.

---

### **Задача 5.2 — Logging и конфигурация**

**Цель:** прозрачный, безопасный лог.

**Описание:**

* `zap` или `logrus` + уровни
* Без `PII` в логах
* ENV переменные:

    * `BOT_TOKEN`
    * `MAX_FILES`
    * `MAX_FILE_SIZE_MB`

**DoD:** лог содержит только служебную информацию.

---

### **Задача 5.3 — Docker + документация**

**Описание:**

* `Dockerfile` + `docker-compose.yml`
* `README.md`:

    * как экспортировать файл из Telegram
    * как отправить в бота
    * как выполнить `docker compose up`

**DoD:**

* Проект поднимается на чистой машине за < 5 минут.

---

# Конечные артефакты

* Telegram-бот
* GitHub repo
* Docker-compose
* Excel пример
* ARCHITECTURE.md
* README.md
* TECH_LIMITS.md