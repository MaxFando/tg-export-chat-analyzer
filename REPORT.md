# BotCreators. Telegram-бот для анализа экспортов чатов и извлечения участников

## Информация о проекте

| Параметр         | Значение                                            |
|------------------|-----------------------------------------------------|
| Название проекта | Telegram Export Chat Analyzer Bot                   |
| Команда          | 5 Go-разработчиков                                  |
| Язык разработки  | Go                                                  |
| Инструменты      | Docker, Docker Compose                              |
| Репозиторий      | https://github.com/MaxFando/tg-export-chat-analyzer |

---

## Выполненные требования брифа

Все требования брифа полностью реализованы:

### 1. Приём файлов экспорта

- Бот принимает до 10 файлов
- Поддерживаются форматы JSON и HTML
- Валидация размера файла (до 10 МБ на файл, 100 МБ в сессии)
- Понятные сообщения об ошибках при превышении лимитов

### 2. Извлечение участников

- Сбор всех авторов сообщений
- Извлечение упоминанных пользователей (через @username)
- Удаление дублей
- Фильтрация удалённых аккаунтов

### 3. Формирование результата

- До 50 участников → список в чат
- От 51+ участников → Excel-файл
- Разделение на вкладки в Excel (Participants, Mentions, Channels)

### 4. Безопасность и приватность

- Временные файлы удаляются сразу после обработки
- Отсутствие сохранения пользовательских данных
- Логирование без PII (личные данные хешируются)

### 5. Docker и развёртывание

- Dockerfile с многошаговой сборкой
- docker-compose.yml с готовыми конфигурациями
- Поддержка ENV переменных
- Готовность к production-запуску

---

## Соответствие задачам заказчика

### Реальная ценность решения

Бот полностью решает задачу заказчика:

**Проблема заказчика:** Нужно быстро и безопасно извлекать список участников из экспортов чатов Telegram, не сохраняя
при этом данные на сервере.

**Решение:** Telegram-бот, который:

- Принимает файлы в несколько кликов
- Обрабатывает их за секунды
- Возвращает результат в удобном формате (список или Excel)
- Гарантирует удаление всех временных файлов
- Работает в облаке или локально

**UX и стабильность:**

- Удобный диалог: каждый шаг проиллюстрирован понятными сообщениями на русском
- Стабильный: обработка ошибок на каждом уровне
- Быстрый: анализ файлов выполняется за секунды
- Безопасный: нет риска утечки данных

**Сценарий использования:**

1. Пользователь → /start → Приветствие и инструкция
2. Пользователь отправляет файлы → Подтверждение получения
3. Пользователь → /process → Начало анализа
4. Бот обрабатывает файлы → Показывает статус
5. Результат → Список или Excel (в зависимости от количества)
6. Временные файлы автоматически удалены

---

## Глубина технической реализации

### Продуманная архитектура

**Архитектурные принципы:**

#### 1. Чистая архитектура с слоями

```
cmd/bot/                    - Точка входа (main.go)
internal/delivery/telegram/ - Слой доставки (Bot API)
internal/service/           - Бизнес-логика
├── parser/                 - Парсинг JSON/HTML
├── participant/            - Извлечение участников
├── export/                 - Экспорт в Excel/список
└── session/                - Управление состоянием
pkg/logger/                 - Логирование без PII
```

#### 2. Интерфейсы и зависимости

```
type Parser interface {
    Parse(file io.Reader, filename string) ([]ChatEvent, error)
}

type Extractor interface {
    Extract(events []ChatEvent) (ParticipantsResult, error)
}

type Exporter interface {
    Export(result ParticipantsResult) ([]byte, error)
}
```

#### 3. Использование библиотек

**Основные зависимости:**

- `go-telegram-bot-api/v5 v5.5.1` – официальный API для Telegram
- `excelize/v2 v2.10.0` – создание Excel файлов

**Кастомные библиотеки, разработанные командой:**

- `github.com/Nikalively/telegram-export-parser v0.0.0-20260105205752-765a98f5cd13` – парсинг экспортов Telegram в
  стандартные форматы
- `github.com/inqast/fstorage v0.0.0-20260111093559-a6e08d865c4a` – управление временными файлами с поддержкой различных
  хранилищ
- `github.com/lintenved/tg-exporter v0.0.0-20251222182205-98bb3a5747cf` – форматирование и экспорт результатов анализа

#### 4. Обработка ошибок

- На каждом уровне – валидация входных данных
- Graceful recovery из паник
- Понятные сообщения об ошибках для пользователя
- Логирование всех критических событий

#### 5. Управление ресурсами

- Сессии пользователей с timeout
- Автоматическая очистка временных файлов
- Валидация размеров файлов и сессий
- Горутины для параллельной обработки

**Примеры реализации:**

Валидация размера:

```
if fileSize > int64(b.maxFileSizeMB)*1024*1024 {
    return errors.New("file too large")
}
```

Управление сессией:

```
func (sm *Manager) cleanupExpired() {
    ticker := time.NewTicker(1 * time.Minute)
    for range ticker.C {
        sm.removeExpiredSessions()
    }
}
```

Выбор формата:

```
if len(result.Participants) >= 51 {
    return exportToExcel(result)
} else {
    return formatForTelegram(result)
}
```

---

## Логичность и структура решения

### Понятная и хорошо документированная архитектура

**Структура кода:**

#### 1. Модули и ответственность

| Файл                     | Ответственность                    |
|--------------------------|------------------------------------|
| telegram/bot.go          | Управление ботом, обработка команд |
| telegram/messages.go     | Все текстовые сообщения (UI)       |
| participant/extractor.go | Извлечение участников из событий   |
| export/service.go        | Выбор формата и экспорт            |
| session/session.go       | Управление сессиями пользователей  |
| logger/logger.go         | Безопасное логирование без PII     |

#### 2. Поток данных

```
Telegram API
    |
bot.handleMessage()
    |
session.GetOrCreate() → сохранение файла
    |
participant.Extract() → сбор участников
    |
export.Export() → выбор формата
    |
Отправка результата
    |
storage.Delete() → удаление временных файлов
```

#### 3. Конфигурация через ENV

| Переменная              | Значение          | Описание                        |
|-------------------------|-------------------|---------------------------------|
| TELEGRAM_BOT_TOKEN      | -                 | Обязательно                     |
| LOG_LEVEL               | info              | debug, info, warn, error        |
| MAX_FILES               | 10                | Лимит файлов в сессии           |
| MAX_FILE_SIZE_MB        | 10                | Лимит размера одного файла      |
| MAX_TOTAL_SIZE_MB       | 100               | Лимит общего размера            |
| SESSION_TIMEOUT_MINUTES | 60                | Время жизни сессии              |
| TEMP_DIR                | /tmp/telegram-bot | Директория для временных файлов |

#### 4. Документация

- messages.go содержит все тексты с пояснениями
- Комментарии в коде объясняют логику
- Названия функций и переменных описательны
- Обработка ошибок явная и понятная

---

## Практическая применимость и качество

Бот полностью готов к использованию в production

### 1. Развёртывание за 5 минут

**Шаг 1: Клонировать репозиторий**

```bash
git clone git@github.com:MaxFando/tg-export-chat-analyzer.git
cd github.com/MaxFando/tg-export-chat-analyzer
```

**Шаг 2: Создать .env файл**

```bash
cp .env.example .env
# Вставить TELEGRAM_BOT_TOKEN из BotFather
```

**Шаг 3: Запустить Docker**

```bash
docker-compose up -d
```

**Шаг 4: Проверить логи**

```bash
docker-compose logs -f bot
```

Готово! Бот работает.

### 2. Все требования production-ready

- Graceful shutdown при ошибках
- Логирование всех операций
- Обработка паник в горутинах
- Валидация входных данных
- Безопасное управление файлами
- Поддержка масштабирования (можно добавить load balancer)

### 3. Мониторинг и отладка

| Команда                             | Описание                          |
|-------------------------------------|-----------------------------------|
| `docker-compose logs -f bot`        | Просмотр логов в реальном времени |
| `LOG_LEVEL=debug docker-compose up` | Установка уровня логирования      |
| `docker-compose ps`                 | Проверка статуса                  |

---

## Основные возможности бота

### Команды

| Команда  | Описание                           |
|----------|------------------------------------|
| /start   | Главное меню, приветствие          |
| /upload  | Загрузить до 10 файлов             |
| /process | Начать анализ загруженных файлов   |
| /help    | Справка и инструкция               |
| /cancel  | Отменить операцию, очистить сессию |

### Поддерживаемые форматы

- JSON (основной формат Telegram Export)
- HTML (частичная поддержка)

### Ограничения (настраиваются через ENV)

| Параметр                | Значение | Описание                           |
|-------------------------|----------|------------------------------------|
| MAX_FILES               | 10       | Максимум файлов в сессии           |
| MAX_FILE_SIZE_MB        | 10       | Максимальный размер одного файла   |
| MAX_TOTAL_SIZE_MB       | 100      | Максимальный общий размер в сессии |
| SESSION_TIMEOUT_MINUTES | 60       | Время жизни сессии                 |

### Результаты

- До 50 участников → список в чат
- 51+ участников → Excel файл с вкладками:
    - Participants – все авторы сообщений
    - Mentions – упомянутые пользователи
    - Channels – обнаруженные каналы

---

## Безопасность и приватность

### Гарантии

- Отсутствие сохранения данных – временные файлы удаляются сразу после обработки
- Логирование без PII – в логах только служебная информация
- Валидация размеров – защита от DoS-атак через большие файлы
- Timeout сессий – автоматическая очистка забытых сессий
- Обработка ошибок – нет утечки информации в сообщениях об ошибках

### Логирование

```
[INFO] bot initialized, botname=ExportAnalyzerBot
[INFO] received message, userID=hash_of_user_id, text=/start
[INFO] file uploaded, userID=hash, filename_hash=hash
[ERROR] failed to parse file, error=invalid json format
```

---

## Как использовать бот

### Шаг 1: Экспортировать чат из Telegram

1. Откройте чат или группу в Telegram Desktop
2. Нажмите на название чата (вверху)
3. Нажмите на меню (три точки)
4. Выберите "Экспортировать историю чата"
5. Выберите формат JSON (рекомендуется)
6. Дождитесь готовности файла

### Шаг 2: Отправить боту

1. Начните диалог с ботом: /start
2. Отправьте файл экспорта (или несколько файлов)
3. Выполните команду: /process

### Шаг 3: Получить результат

- Если участников < 50 → список в чат
- Если участников ≥ 51 → Excel файл

### Шаг 4: Данные удалены

Все временные файлы автоматически удаляются со сервера.

---

## Развёртывание и поддержка

### Docker запуск

```bash
docker-compose up -d
docker-compose logs -f
```

### Масштабирование

Текущая архитектура поддерживает развёртывание нескольких экземпляров бота:

- Каждый бот работает независимо
- Сессии хранятся in-memory (можно добавить Redis для кластера)
- Временные файлы хранятся локально (можно добавить S3 для облака)

---

## Дополнительная информация

### Использованные технологии

- Go 1.24 – язык программирования
- Docker & Docker Compose – контейнеризация
- Telegram Bot API – интеграция с Telegram
- excelize – работа с Excel
- fstorage – управление файлами

---

## Артефакты проекта

### Код и конфигурация

- cmd/bot/main.go – точка входа
- internal/delivery/telegram/bot.go – основная логика бота
- internal/delivery/telegram/messages.go – все текстовые сообщения
- internal/service/participant/ – сервис извлечения участников
- internal/service/export/ – сервис экспорта
- internal/service/session/ – управление сессиями
- pkg/logger/ – логирование без PII
- Dockerfile – Docker образ
- docker-compose.yml – оркестрация контейнеров
- .env.example – пример конфигурации

---

## Заключение

Проект полностью выполнен в соответствии с требованиями заказчика.

**Telegram-бот:**

- Работает стабильно и готов к production
- Имеет интуитивный и удобный UI на русском
- Гарантирует безопасность и приватность данных
- Легко развёртывается через Docker
- Хорошо структурирован и документирован
- Решает реальную задачу заказчика
